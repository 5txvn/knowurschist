<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study - Chemistry</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  <script>
    window.MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']]
      }
    };
  </script>
  <style>
    html, body {
        overflow: scroll;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    
    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
        display: none;
    }
    
    body {
      background: #fafafa;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .navbar-container {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem 0;
    }
    
    #navbar-placeholder {
      width: 100%;
      display: flex;
      justify-content: center;
    }
    
    .content-wrapper {
      padding-top: 0;
    }
    
    .game-mode-card {
      transition: all 0.3s ease;
      cursor: pointer;
      border-radius: 20px;
      box-shadow: 8px 8px 16px rgba(0,0,0,0.08), -8px -8px 16px rgba(255,255,255,0.8);
    }
    
    .game-mode-card:hover {
      box-shadow: 10px 10px 20px rgba(0,0,0,0.1), -10px -10px 20px rgba(255,255,255,0.9);
    }
    
    .flashcard {
      perspective: 1000px;
      width: 100%;
      height: 400px;
    }
    
    .flashcard-inner {
      position: relative;
      width: 100%;
      height: 100%;
      transition: transform 0.6s;
      transform-style: preserve-3d;
    }
    
    .flashcard.flipped .flashcard-inner {
      transform: rotateY(180deg);
    }
    
    .flashcard-front, .flashcard-back {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
      background: white;
      border: 2px solid black;
    }
    
    .flashcard-back {
      transform: rotateY(180deg);
    }
    
    .flashcard-text {
      font-size: clamp(1.5rem, 4vw, 3rem);
      text-align: center;
    }
    
    .flashcard-nav {
      display: flex;
      gap: 0;
      background: white;
      padding: 4px;
      width: fit-content;
      margin: 0 auto;
      border-radius: 9999px;
    }
    
    .flashcard-nav button {
      padding: 12px 20px;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .flashcard-nav button:first-child {
      border-radius: 9999px 0 0 9999px;
    }
    
    .flashcard-nav button:last-child {
      border-radius: 0 9999px 9999px 0;
    }
    
    .flashcard-nav button.nav-center {
      border-radius: 0;
    }
    
    .flashcard-nav button:hover {
      background: #f0f0f0;
    }
    
    .flashcard-nav button.nav-black {
      background: black;
      color: white;
    }
    
    .flashcard-nav button.nav-black:hover {
      background: #333;
    }
    
    .flashcard-nav button.nav-green {
      background: #a855f7;
      color: white;
    }
    
    .flashcard-nav button.nav-green:hover {
      background: #9333ea;
    }
    
    /* Custom Select Styling */
    #key-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23333' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      padding-right: 2.5rem;
      appearance: none;
    }
    
    #key-select:focus {
      border-color: #a855f7;
      outline: none;
    }
    
    #key-select option {
      padding: 0.5rem;
      background: white;
    }
    
    #key-select option:checked {
      background: #f3f4f6 !important;
      color: black;
    }
    
    #key-select option:hover {
      background: #f3f4f6;
    }
    
    .matching-item {
      transition: all 0.2s ease;
    }
    
    .matching-item:hover {
      transform: translateY(-2px);
    }
    
    .matching-item.selected {
      border-color: #a855f7;
      background-color: #faf5ff;
    }
    
    .matching-item.matched {
      opacity: 0.5;
      pointer-events: none;
    }
    
    .quiz-option {
      transition: all 0.2s ease;
    }
    
    .quiz-option:hover:not(:disabled) {
      transform: translateX(4px);
      background-color: #f0f0f0;
    }
    
    .quiz-option.correct {
      background-color: #a855f7;
      color: white;
      border-color: #a855f7;
    }
    
    .quiz-option.incorrect {
      background-color: #ef4444;
      color: white;
      border-color: #ef4444;
    }
    
    .quiz-option:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
    
    .recall-option-btn {
      transition: all 0.2s ease;
    }
    
    .recall-option-btn:hover:not(:disabled) {
      transform: translateX(4px);
      background-color: #f0f0f0;
    }
    
    .question-arrow {
      position: absolute;
      top: 12px;
      right: 24px;
      width: 40px;
      height: 40px;
      background: white;
      border: 1px solid black;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .question-arrow:hover {
      background: #f0f0f0;
    }
    
    .question-arrow.visible {
      display: flex;
    }
    
    .question-arrow i {
      color: black;
    }
  </style>
</head>
<body>
  <div class="navbar-container">
    <div id="navbar-placeholder"></div>
  </div>
  
  <div class="content-wrapper pb-12 px-4 md:px-8 lg:px-16 max-w-7xl mx-auto md:mt-12">
    <div class="mb-8 md:mb-16 text-center md:text-left">
      <h1 class="text-5xl mb-8 my-[-15px] block md:hidden">‚öõÔ∏è</h1>
      <h1 class="text-5xl font-bold text-gray-900 mb-4 hidden md:block">‚öõÔ∏è Study</h1>
    </div>
    
    <!-- Memorization Set Selection -->
    <div class="mb-16">
      <select id="key-select" class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none text-lg">
        <option value="">Select a memorization set...</option>
        <option value="formulas">Formulas</option>
        <option value="periodicTableSymbols">Periodic Table Symbols</option>
        <option value="elementNamesToSymbols">Element Names to Symbols</option>
        <option value="atomicMasses">Atomic Masses</option>
        <option value="flameTestColors">Flame Test Colors</option>
        <option value="ionicCharges">Ionic Charges</option>
        <option value="acidsBases">Strong/Weak Acids and Bases</option>
      </select>
    </div>
    
    <!-- Game Modes -->
    <div id="game-modes" class="hidden mb-16">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div class="game-mode-card bg-white p-8" onclick="startMode('flashcards')">
          <div class="w-16 h-16 bg-purple-500 rounded-xl flex items-center justify-center mb-4">
            <i class="fas fa-clone text-white text-3xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Flashcards</h3>
          <p class="text-gray-600">Flip through terms and definitions</p>
        </div>
        
        <div class="game-mode-card bg-white p-8" onclick="startMode('matching')">
          <div class="w-16 h-16 bg-black rounded-xl flex items-center justify-center mb-4">
            <i class="fas fa-link text-white text-3xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Matching</h3>
          <p class="text-gray-600">Match terms with their definitions</p>
        </div>
        
        <div class="game-mode-card bg-white p-8" onclick="startMode('quiz')">
          <div class="w-16 h-16 bg-purple-500 rounded-xl flex items-center justify-center mb-4">
            <i class="fas fa-question-circle text-white text-3xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Quiz</h3>
          <p class="text-gray-600">Test your knowledge with multiple choice</p>
        </div>
        
        <div class="game-mode-card bg-white p-8" onclick="startMode('active-recall')">
          <div class="w-16 h-16 bg-black rounded-xl flex items-center justify-center mb-4">
            <i class="fas fa-brain text-white text-3xl"></i>
          </div>
          <h3 class="text-2xl font-bold text-gray-900 mb-2">Active Recall</h3>
          <p class="text-gray-600">Type the definition from memory</p>
        </div>
      </div>
    </div>
    
    <!-- Flashcards Mode -->
    <div id="flashcards-mode" class="hidden">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Flashcards</h2>
        <button onclick="exitMode()" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div class="mb-4 text-center">
        <span class="text-gray-600">Card <span id="flashcard-num">1</span> of <span id="flashcard-total">0</span></span>
      </div>
      <div class="flashcard" id="flashcard">
        <div class="flashcard-inner">
          <div class="flashcard-front">
            <div class="text-center">
              <p class="flashcard-text font-bold text-gray-900" id="flashcard-term"></p>
            </div>
          </div>
          <div class="flashcard-back">
            <div class="text-center">
              <p class="flashcard-text text-gray-700" id="flashcard-definition"></p>
            </div>
          </div>
        </div>
      </div>
      <div class="mt-6 flex justify-center">
        <div class="flashcard-nav">
          <button onclick="prevCard()" class="nav-green">
            <i class="fas fa-chevron-left"></i>
          </button>
          <button onclick="flipCard()" class="nav-black nav-center">
            <i class="fas fa-sync-alt"></i>
          </button>
          <button onclick="nextCard()" class="nav-green">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Matching Mode -->
    <div id="matching-mode" class="hidden">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Matching</h2>
        <button onclick="exitMode()" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div class="mb-4">
        <input type="number" id="matching-term-count" min="1" placeholder="Number of terms (default: 8)" value="8" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
      </div>
      <div class="mb-4 text-center">
        <span class="text-gray-600">Matches: <span id="match-count">0</span> / <span id="match-total">0</span></span>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-xl font-bold text-gray-900 mb-4">Terms</h3>
          <div id="terms-container" class="space-y-3"></div>
        </div>
        <div>
          <h3 class="text-xl font-bold text-gray-900 mb-4">Definitions</h3>
          <div id="definitions-container" class="space-y-3"></div>
        </div>
      </div>
    </div>
    
    <!-- Quiz Mode Setup -->
    <div id="quiz-setup" class="hidden mb-8">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Quiz</h2>
        <button onclick="exitMode()" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div class="mb-6">
        <input type="number" id="quiz-question-count" min="1" placeholder="Number of questions (leave blank for freeplay)" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
      </div>
      <button onclick="startQuiz()" class="w-full bg-black text-white py-3 rounded-lg font-semibold transition-all hover:-translate-y-1">
        Start Quiz
      </button>
    </div>
    
    <!-- Quiz Mode -->
    <div id="quiz-mode" class="hidden">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Quiz</h2>
        <button onclick="exitMode()" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <!-- Progress Bar (only in fixed mode) -->
      <div id="quiz-progress-container" class="mb-6 hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">Question <span id="quiz-num">1</span> of <span id="quiz-total">0</span></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="quiz-progress-bar" class="bg-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      
      <!-- Stats (only in freeplay mode) -->
      <div id="quiz-freeplay-stats" class="mb-6 bg-white rounded-lg p-4 border-2 border-gray-200 hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div>
            <div class="text-2xl font-bold text-gray-900" id="quiz-stat-accuracy">0%</div>
            <div class="text-sm text-gray-600">Accuracy</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-purple-600" id="quiz-stat-correct">‚úì 0</div>
            <div class="text-sm text-gray-600">Correct</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-red-600" id="quiz-stat-incorrect">‚úó 0</div>
            <div class="text-sm text-gray-600">Incorrect</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-orange-600" id="quiz-stat-streak">üî• 0</div>
            <div class="text-sm text-gray-600">Streak</div>
          </div>
        </div>
      </div>
      
      <div class="question-card bg-white rounded-xl p-8 border-2 border-gray-200 mb-6 relative">
        <div class="question-arrow" id="quiz-arrow" onclick="nextQuizQuestion()">
          <i class="fas fa-arrow-right"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-6" id="quiz-term"></h3>
        <div class="space-y-3" id="quiz-options"></div>
      </div>
    </div>
    
    <!-- Active Recall Mode Setup -->
    <div id="recall-setup" class="hidden mb-8">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Active Recall</h2>
        <button onclick="exitMode()" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      <div class="mb-6">
        <select id="recall-mode" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
          <option value="definition">Answer with Terms</option>
          <option value="term">Answer with Definition</option>
        </select>
      </div>
      <div class="mb-6">
        <input type="number" id="recall-question-count" min="1" placeholder="Number of questions (leave blank for freeplay)" class="w-full p-3 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none">
      </div>
      <button onclick="startRecall()" class="w-full bg-black text-white py-3 rounded-lg font-semibold transition-all hover:-translate-y-1">
        Start Active Recall
      </button>
    </div>
    
    <!-- Active Recall Mode -->
    <div id="active-recall-mode" class="hidden">
      <div class="mb-6 flex items-center justify-between">
        <h2 class="text-3xl font-bold text-gray-900">Active Recall</h2>
        <button onclick="exitMode()" class="text-gray-600 hover:text-gray-900">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <!-- Progress Bar (only in fixed mode) -->
      <div id="recall-progress-container" class="mb-6 hidden">
        <div class="flex justify-between items-center mb-2">
          <span class="text-sm font-medium text-gray-600">Question <span id="recall-num">1</span> of <span id="recall-total">0</span></span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div id="recall-progress-bar" class="bg-purple-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
      
      <!-- Stats (only in freeplay mode) -->
      <div id="recall-freeplay-stats" class="mb-6 bg-white rounded-lg p-4 border-2 border-gray-200 hidden">
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div>
            <div class="text-2xl font-bold text-gray-900" id="recall-stat-accuracy">0%</div>
            <div class="text-sm text-gray-600">Accuracy</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-purple-600" id="recall-stat-correct">‚úì 0</div>
            <div class="text-sm text-gray-600">Correct</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-red-600" id="recall-stat-incorrect">‚úó 0</div>
            <div class="text-sm text-gray-600">Incorrect</div>
          </div>
          <div>
            <div class="text-2xl font-bold text-orange-600" id="recall-stat-streak">üî• 0</div>
            <div class="text-sm text-gray-600">Streak</div>
          </div>
        </div>
      </div>
      
      <div class="question-card bg-white rounded-xl p-8 border-2 border-gray-200 mb-6 relative">
        <div class="question-arrow" id="recall-arrow" onclick="nextRecall()">
          <i class="fas fa-arrow-right"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-900 mb-6" id="recall-prompt"></h3>
        <textarea id="recall-answer" placeholder="Type your answer here..." class="w-full p-4 border-2 border-gray-200 rounded-lg focus:border-purple-500 focus:outline-none h-32"></textarea>
        <button onclick="checkRecall()" class="mt-4 w-full bg-purple-500 text-white py-3 rounded-lg font-semibold hover:bg-purple-600">
          Check Answer
        </button>
      </div>
      
      <div id="recall-feedback" class="hidden bg-white rounded-xl p-6 border-2 border-gray-200 mb-6">
        <div id="recall-feedback-content"></div>
      </div>
    </div>
  </div>
  
  <script>
    let currentKey = null;
    let terms = [];
    let currentMode = null;
    let currentIndex = 0;
    let selectedTerm = null;
    let selectedDefinition = null;
    let matchedPairs = [];
    let shuffledTerms = [];
    let shuffledDefinitions = [];
    let quizAnswers = [];
    let shuffledOptions = [];
    let quizIsFreeplay = true;
    let quizTargetCount = 0;
    let quizCurrentIndex = 0;
    let quizCorrectCount = 0;
    let quizIncorrectCount = 0;
    let quizStreak = 0;
    let quizTotalAnswered = 0;
    let quizSelectedAnswer = null;
    let quizShowingFeedback = false;
    let quizShuffledTerms = [];
    let recallIsFreeplay = true;
    let recallTargetCount = 0;
    let recallCurrentIndex = 0;
    let recallCorrectCount = 0;
    let recallIncorrectCount = 0;
    let recallStreak = 0;
    let recallTotalAnswered = 0;
    let recallMode = 'definition';
    let recallShuffledTerms = [];
    let recallShowingFeedback = false;
    
    $(document).ready(function() {
      $('#navbar-placeholder').load('../navbar.html');
      
      // Check for key parameter in URL
      const urlParams = new URLSearchParams(window.location.search);
      const keyParam = urlParams.get('key');
      if (keyParam) {
        $('#key-select').val(keyParam);
        loadKey(keyParam);
      }
      
      $('#key-select').on('change', function() {
        const key = $(this).val();
        if (key) {
          loadKey(key);
        } else {
          $('#game-modes').addClass('hidden');
        }
      });
    });
    
    async function loadKey(keyName) {
      try {
        const response = await fetch(`json/${keyName}.json`);
        const data = await response.json();
        
        // Convert object to array format if needed
        if (Array.isArray(data)) {
          terms = data;
        } else {
          // Convert object {key: value} to array [{term: key, definition: value}]
          terms = Object.entries(data).map(([term, definition]) => ({
            term: term,
            definition: definition
          }));
        }
        
        if (terms.length === 0) {
          alert('No terms found in this set.');
          return;
        }
        
        currentKey = keyName;
        $('#game-modes').removeClass('hidden');
        
        // Render MathJax after loading
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
      } catch (error) {
        console.error('Error loading memorization set:', error);
        alert('Error loading memorization set. Please try again.');
      }
    }
    
    function startMode(mode) {
      currentMode = mode;
      $('#game-modes').addClass('hidden');
      
      if (mode === 'flashcards') {
        currentIndex = 0;
        $('#flashcards-mode').removeClass('hidden');
        displayFlashcard();
      } else if (mode === 'matching') {
        setupMatching();
        $('#matching-mode').removeClass('hidden');
      } else if (mode === 'quiz') {
        $('#quiz-setup').removeClass('hidden');
      } else if (mode === 'active-recall') {
        $('#recall-setup').removeClass('hidden');
      }
    }
    
    function exitMode() {
      currentMode = null;
      $('#flashcards-mode').addClass('hidden');
      $('#matching-mode').addClass('hidden');
      $('#quiz-setup').addClass('hidden');
      $('#quiz-mode').addClass('hidden');
      $('#recall-setup').addClass('hidden');
      $('#active-recall-mode').addClass('hidden');
      $('#game-modes').removeClass('hidden');
    }
    
    // Flashcards
    function displayFlashcard() {
      if (currentIndex >= terms.length) currentIndex = 0;
      if (currentIndex < 0) currentIndex = terms.length - 1;
      
      const card = terms[currentIndex];
      $('#flashcard-term').html(card.term);
      $('#flashcard-definition').html(card.definition);
      $('#flashcard-num').text(currentIndex + 1);
      $('#flashcard-total').text(terms.length);
      $('#flashcard').removeClass('flipped');
      
      // Render MathJax
      if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('flashcard-term'), document.getElementById('flashcard-definition')]);
      }
    }
    
    function flipCard() {
      $('#flashcard').toggleClass('flipped');
    }
    
    function nextCard() {
      currentIndex++;
      displayFlashcard();
    }
    
    function prevCard() {
      currentIndex--;
      displayFlashcard();
    }
    
    // Keyboard navigation for flashcards
    $(document).on('keydown', function(e) {
      if (currentMode === 'flashcards') {
        if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
          e.preventDefault();
          flipCard();
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          nextCard();
        } else if (e.key === 'ArrowLeft') {
          e.preventDefault();
          prevCard();
        }
      }
    });
    
    // Matching
    function setupMatching() {
      matchedPairs = [];
      selectedTerm = null;
      selectedDefinition = null;
      
      // Get number of terms from input, default to 8
      let numTerms = parseInt($('#matching-term-count').val()) || 8;
      // Limit to available terms
      numTerms = Math.min(numTerms, terms.length);
      
      // Shuffle and take only the requested number
      const allShuffled = [...terms].sort(() => Math.random() - 0.5);
      const selectedTerms = allShuffled.slice(0, numTerms);
      
      shuffledTerms = [...selectedTerms].sort(() => Math.random() - 0.5);
      shuffledDefinitions = [...selectedTerms].sort(() => Math.random() - 0.5);
      
      const termsContainer = $('#terms-container');
      termsContainer.empty();
      shuffledTerms.forEach((item, index) => {
        const div = $('<div></div>')
          .addClass('matching-item p-4 bg-white border-2 border-gray-200 rounded-lg cursor-pointer')
          .attr('data-term-index', index)
          .html(item.term)
          .on('click', function() { selectTerm(index); });
        termsContainer.append(div);
      });
      
      const definitionsContainer = $('#definitions-container');
      definitionsContainer.empty();
      shuffledDefinitions.forEach((item, index) => {
        const div = $('<div></div>')
          .addClass('matching-item p-4 bg-white border-2 border-gray-200 rounded-lg cursor-pointer')
          .attr('data-def-index', index)
          .html(item.definition)
          .on('click', function() { selectDefinition(index); });
        definitionsContainer.append(div);
      });
      
      // Render MathJax
      if (window.MathJax) {
        MathJax.typesetPromise([termsContainer[0], definitionsContainer[0]]);
      }
      
      $('#match-count').text(0);
      $('#match-total').text(numTerms);
    }
    
    function selectTerm(index) {
      const item = $(`.matching-item[data-term-index="${index}"]`);
      if (item.hasClass('matched')) return;
      
      $('.matching-item').removeClass('selected');
      item.addClass('selected');
      selectedTerm = index;
      checkMatch();
    }
    
    function selectDefinition(index) {
      const item = $(`.matching-item[data-def-index="${index}"]`);
      if (item.hasClass('matched')) return;
      
      $('.matching-item').removeClass('selected');
      item.addClass('selected');
      selectedDefinition = index;
      checkMatch();
    }
    
    function checkMatch() {
      if (selectedTerm !== null && selectedDefinition !== null) {
        const termItem = shuffledTerms[selectedTerm];
        const defItem = shuffledDefinitions[selectedDefinition];
        
        if (termItem.term === defItem.term) {
          // Match!
          $(`.matching-item[data-term-index="${selectedTerm}"]`).addClass('matched');
          $(`.matching-item[data-def-index="${selectedDefinition}"]`).addClass('matched');
          matchedPairs.push({ term: selectedTerm, def: selectedDefinition });
          $('#match-count').text(matchedPairs.length);
          
          if (matchedPairs.length === terms.length) {
            setTimeout(() => {
              alert('Congratulations! You matched all pairs!');
            }, 500);
          }
        } else {
          // Wrong match
          setTimeout(() => {
            $('.matching-item').removeClass('selected');
          }, 500);
        }
        
        selectedTerm = null;
        selectedDefinition = null;
      }
    }
    
    // Quiz
    function startQuiz() {
      const questionCountVal = $('#quiz-question-count').val().trim();
      if (questionCountVal === '') {
        quizIsFreeplay = true;
      } else {
        quizIsFreeplay = false;
        quizTargetCount = parseInt(questionCountVal);
        if (!quizTargetCount || quizTargetCount < 1) {
          alert('Please enter a valid number of questions.');
          return;
        }
      }
      
      quizCurrentIndex = 0;
      quizCorrectCount = 0;
      quizIncorrectCount = 0;
      quizStreak = 0;
      quizTotalAnswered = 0;
      quizSelectedAnswer = null;
      quizShowingFeedback = false;
      quizShuffledTerms = [...terms].sort(() => Math.random() - 0.5);
      
      $('#quiz-setup').addClass('hidden');
      $('#quiz-mode').removeClass('hidden');
      $('#quiz-arrow').removeClass('visible');
      
      if (quizIsFreeplay) {
        $('#quiz-progress-container').addClass('hidden');
        $('#quiz-freeplay-stats').removeClass('hidden');
      } else {
        $('#quiz-progress-container').removeClass('hidden');
        $('#quiz-freeplay-stats').addClass('hidden');
        $('#quiz-total').text(quizTargetCount);
      }
      
      displayQuizQuestion();
    }
    
    function displayQuizQuestion() {
      if (!quizIsFreeplay && quizCurrentIndex >= quizTargetCount) {
        showQuizResults();
        return;
      }
      
      if (quizCurrentIndex >= quizShuffledTerms.length) {
        quizCurrentIndex = 0;
      }
      
      const correctTerm = quizShuffledTerms[quizCurrentIndex];
      $('#quiz-term').text(`What is the definition of "${correctTerm.term}"?`);
      
      if (!quizIsFreeplay) {
        $('#quiz-num').text(quizCurrentIndex + 1);
        const progress = ((quizCurrentIndex) / quizTargetCount) * 100;
        $('#quiz-progress-bar').css('width', progress + '%');
      }
      
      // Create options
      const options = [correctTerm.definition];
      while (options.length < 4) {
        const random = terms[Math.floor(Math.random() * terms.length)];
        if (!options.includes(random.definition)) {
          options.push(random.definition);
        }
      }
      
      shuffledOptions = options.sort(() => Math.random() - 0.5);
      const correctIndex = shuffledOptions.indexOf(correctTerm.definition);
      
      const optionsContainer = $('#quiz-options');
      optionsContainer.empty();
      shuffledOptions.forEach((option, index) => {
        const btn = $('<button></button>')
          .addClass('quiz-option w-full text-left p-4 bg-gray-50 border-2 border-gray-200 rounded-lg font-medium')
          .attr('data-index', index)
          .html(`${String.fromCharCode(65 + index)}. ${option}`)
          .on('click', function() { selectQuizAnswer(index, correctIndex); });
        optionsContainer.append(btn);
      });
      
      // Render MathJax
      if (window.MathJax) {
        MathJax.typesetPromise([document.getElementById('quiz-term'), document.getElementById('quiz-options')]);
      }
      
      quizShowingFeedback = false;
      $('#quiz-arrow').removeClass('visible');
    }
    
    function selectQuizAnswer(selected, correct) {
      if (quizShowingFeedback) return;
      
      $('.quiz-option').prop('disabled', true);
      quizSelectedAnswer = selected;
      
      if (selected === correct) {
        $(`.quiz-option[data-index="${selected}"]`).addClass('correct');
        quizCorrectCount++;
        quizStreak++;
        quizTotalAnswered++;
      } else {
        $(`.quiz-option[data-index="${selected}"]`).addClass('incorrect');
        $(`.quiz-option[data-index="${correct}"]`).addClass('correct');
        quizIncorrectCount++;
        quizStreak = 0;
        quizTotalAnswered++;
      }
      
      quizShowingFeedback = true;
      $('#quiz-arrow').addClass('visible');
      updateQuizStats();
    }
    
    function updateQuizStats() {
      if (quizIsFreeplay) {
        const accuracy = quizTotalAnswered > 0 ? Math.round((quizCorrectCount / quizTotalAnswered) * 100) : 0;
        $('#quiz-stat-accuracy').text(accuracy + '%');
        $('#quiz-stat-correct').html('‚úì ' + quizCorrectCount);
        $('#quiz-stat-incorrect').html('‚úó ' + quizIncorrectCount);
        $('#quiz-stat-streak').html('üî• ' + quizStreak);
      }
    }
    
    function nextQuizQuestion() {
      quizCurrentIndex++;
      displayQuizQuestion();
    }
    
    function showQuizResults() {
      const correct = quizCorrectCount;
      const total = quizTotalAnswered;
      $('#quiz-mode').html(`
        <div class="text-center">
          <h2 class="text-4xl font-bold text-gray-900 mb-4">Quiz Complete!</h2>
          <p class="text-2xl text-gray-600 mb-6">Score: ${correct}/${total} (${Math.round(correct/total*100)}%)</p>
          <button onclick="exitMode()" class="bg-purple-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-600">
            Back to Menu
          </button>
        </div>
      `);
    }
    
    // Active Recall
    function startRecall() {
      recallMode = $('#recall-mode').val();
      const questionCountVal = $('#recall-question-count').val().trim();
      if (questionCountVal === '') {
        recallIsFreeplay = true;
      } else {
        recallIsFreeplay = false;
        recallTargetCount = parseInt(questionCountVal);
        if (!recallTargetCount || recallTargetCount < 1) {
          alert('Please enter a valid number of questions.');
          return;
        }
      }
      
      recallCurrentIndex = 0;
      recallCorrectCount = 0;
      recallIncorrectCount = 0;
      recallStreak = 0;
      recallTotalAnswered = 0;
      recallShowingFeedback = false;
      recallShuffledTerms = [...terms].sort(() => Math.random() - 0.5);
      
      $('#recall-setup').addClass('hidden');
      $('#active-recall-mode').removeClass('hidden');
      $('#recall-arrow').removeClass('visible');
      $('#recall-feedback').addClass('hidden');
      
      if (recallIsFreeplay) {
        $('#recall-progress-container').addClass('hidden');
        $('#recall-freeplay-stats').removeClass('hidden');
      } else {
        $('#recall-progress-container').removeClass('hidden');
        $('#recall-freeplay-stats').addClass('hidden');
        $('#recall-total').text(recallTargetCount);
      }
      
      displayRecall();
    }
    
    function displayRecall() {
      if (!recallIsFreeplay && recallCurrentIndex >= recallTargetCount) {
        showRecallResults();
        return;
      }
      
      if (recallCurrentIndex >= recallShuffledTerms.length) {
        recallCurrentIndex = 0;
      }
      
      const term = recallShuffledTerms[recallCurrentIndex];
      
      if (recallMode === 'definition') {
        $('#recall-prompt').text(`What is the definition of "${term.term}"?`);
      } else {
        $('#recall-prompt').text(`What is the term for: "${term.definition}"?`);
      }
      
      $('#recall-answer').val('');
      
      if (!recallIsFreeplay) {
        $('#recall-num').text(recallCurrentIndex + 1);
        const progress = ((recallCurrentIndex) / recallTargetCount) * 100;
        $('#recall-progress-bar').css('width', progress + '%');
      }
      
      recallShowingFeedback = false;
      $('#recall-arrow').removeClass('visible');
      $('#recall-feedback').addClass('hidden');
    }
    
    function checkRecall() {
      if (recallShowingFeedback) return;
      
      const userAnswer = $('#recall-answer').val().trim();
      const term = recallShuffledTerms[recallCurrentIndex];
      
      let correctAnswer, userAnswerLower, correctAnswerLower;
      if (recallMode === 'definition') {
        correctAnswer = term.definition;
        userAnswerLower = userAnswer.toLowerCase();
        correctAnswerLower = correctAnswer.toLowerCase();
      } else {
        correctAnswer = term.term;
        userAnswerLower = userAnswer.toLowerCase();
        correctAnswerLower = correctAnswer.toLowerCase();
      }
      
      // Use Levenshtein distance
      const distance = levenshteinDistance(userAnswerLower, correctAnswerLower);
      const maxLength = Math.max(userAnswerLower.length, correctAnswerLower.length);
      const similarity = maxLength > 0 ? 1 - (distance / maxLength) : 1;
      const isCorrect = similarity > 0.7 || userAnswerLower === correctAnswerLower;
      
      recallTotalAnswered++;
      if (isCorrect) {
        recallCorrectCount++;
        recallStreak++;
      } else {
        recallIncorrectCount++;
        recallStreak = 0;
      }
      
      recallShowingFeedback = true;
      $('#recall-arrow').addClass('visible');
      $('#recall-feedback').removeClass('hidden');
      
      const feedbackContent = $('#recall-feedback-content');
      if (isCorrect) {
        feedbackContent.html(`
          <div class="text-purple-600 font-semibold text-lg mb-4">‚úì Great job!</div>
          <p class="text-gray-700 mb-3"><strong>Your answer:</strong> ${userAnswer}</p>
          <p class="text-gray-700"><strong>Correct answer:</strong> ${correctAnswer}</p>
        `);
      } else {
        feedbackContent.html(`
          <div class="text-red-600 font-semibold text-lg mb-4">‚úó Not quite right</div>
          <p class="text-gray-700 mb-3"><strong>Your answer:</strong> ${userAnswer}</p>
          <p class="text-gray-700"><strong>Correct answer:</strong> ${correctAnswer}</p>
        `);
      }
      
      updateRecallStats();
    }
    
    function updateRecallStats() {
      if (recallIsFreeplay) {
        const accuracy = recallTotalAnswered > 0 ? Math.round((recallCorrectCount / recallTotalAnswered) * 100) : 0;
        $('#recall-stat-accuracy').text(accuracy + '%');
        $('#recall-stat-correct').html('‚úì ' + recallCorrectCount);
        $('#recall-stat-incorrect').html('‚úó ' + recallIncorrectCount);
        $('#recall-stat-streak').html('üî• ' + recallStreak);
      }
    }
    
    function nextRecall() {
      recallCurrentIndex++;
      displayRecall();
    }
    
    function showRecallResults() {
      const correct = recallCorrectCount;
      const total = recallTotalAnswered;
      $('#active-recall-mode').html(`
        <div class="text-center">
          <h2 class="text-4xl font-bold text-gray-900 mb-4">Complete!</h2>
          <p class="text-2xl text-gray-600 mb-6">Score: ${correct}/${total} (${Math.round(correct/total*100)}%)</p>
          <button onclick="exitMode()" class="bg-purple-500 text-white px-8 py-3 rounded-lg font-semibold hover:bg-purple-600">
            Back to Menu
          </button>
        </div>
      `);
    }
    
    function levenshteinDistance(str1, str2) {
      const matrix = [];
      for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
      }
      for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
          if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }
      return matrix[str2.length][str1.length];
    }
  </script>
</body>
</html>

